<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - StudentEvents</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/admin/admin-dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <button class="back-btn-header" onclick="history.back()" aria-label="Go back">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back</span>
                    </button>
                    <div class="logo">
                        <i class="fas fa-ticket-alt"></i>
                        <span>StudentEvents</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="admin-controls">
                        <div class="admin-badge">
                            <i class="fas fa-cog"></i>
                            <span>Admin Portal</span>
                        </div>
                        <button class="logout-btn" onclick="adminLogout()" title="Logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="logout-text">Logout</span>
                        </button>
                    </div>
                    <div class="header-actions">
                        <button class="mobile-menu-toggle" aria-label="Toggle menu">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <a href="/index.html" class="mobile-nav-link">Back to Events</a>
        <a href="/rules.html" class="mobile-nav-link">Rules & Policy</a>
        <a href="#contact" class="mobile-nav-link">Contact</a>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Admin Dashboard
                </h1>
                <p class="dashboard-subtitle">Manage events, workers, and system settings</p>
            </div>

            <!-- Navigation Tabs -->
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="events" onclick="adminDashboard.switchTab('events')">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                </button>
                <button class="tab-btn" data-tab="workers" onclick="adminDashboard.switchTab('workers')">
                    <i class="fas fa-users"></i>
                    <span>Workers</span>
                </button>
                <button class="tab-btn" data-tab="settings" onclick="adminDashboard.switchTab('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Events Tab -->
                <div class="tab-panel active" id="eventsPanel">
                    <div class="panel-header">
                        <h2 class="panel-title">Event Management</h2>
                        <button class="btn btn-primary" onclick="adminDashboard.showCreateEventModal()">
                            <i class="fas fa-plus"></i>
                            Create Event
                        </button>
                    </div>

                    <!-- Events Statistics -->
                    <div class="stats-overview">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalEvents">0</div>
                                <div class="stat-label">Total Events</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalTickets">0</div>
                                <div class="stat-label">Tickets Sold</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalRevenue">‚Ç¨0</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="upcomingEvents">0</div>
                                <div class="stat-label">Upcoming</div>
                            </div>
                        </div>
                    </div>

                    <!-- Events Table -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3>All Events</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary btn-sm" onclick="adminDashboard.exportEvents()">
                                    <i class="fas fa-download"></i>
                                    Export Events
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="adminDashboard.exportParticipants()">
                                    <i class="fas fa-users"></i>
                                    Export Participants
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table" id="eventsTable">
                                <thead>
                                    <tr>
                                        <th>Event Name</th>
                                        <th>Date</th>
                                        <th>Location</th>
                                        <th>Price</th>
                                        <th>Sold/Total</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="eventsTableBody">
                                    <!-- Content will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Workers Tab -->
                <div class="tab-panel" id="workersPanel">
                    <div class="panel-header">
                        <h2 class="panel-title">Worker Management</h2>
                        <button class="btn btn-primary" onclick="adminDashboard.showCreateWorkerModal()">
                            <i class="fas fa-user-plus"></i>
                            Add Worker
                        </button>
                    </div>

                    <!-- Workers Table -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3>All Workers</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary btn-sm" onclick="adminDashboard.exportWorkers()">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table" id="workersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Username</th>
                                        <th>Password</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Last Active</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="workersTableBody">
                                    <!-- Content will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-panel" id="settingsPanel">
                    <div class="panel-header">
                        <h2 class="panel-title">System Settings</h2>
                    </div>

                    <div class="settings-grid">
                        <!-- Organization Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title">
                                <i class="fas fa-building"></i>
                                Organization
                            </h3>
                            <form class="settings-form" id="organizationForm">
                                <div class="form-group">
                                    <label class="form-label" for="orgName">Organization Name</label>
                                    <input type="text" class="form-input" id="orgName" value="StudentEvents">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="orgEmail">Contact Email</label>
                                    <input type="email" class="form-input" id="orgEmail" value="info@studentevents.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="orgPhone">Contact Phone</label>
                                    <input type="tel" class="form-input" id="orgPhone" value="+1 (555) 123-4567">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Save Changes
                                </button>
                            </form>
                        </div>

                        <!-- Policy Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title">
                                <i class="fas fa-file-contract"></i>
                                Policies
                            </h3>
                            <form class="settings-form" id="policyForm">
                                <div class="form-group">
                                    <label class="form-label" for="policyVersion">Policy Version</label>
                                    <input type="text" class="form-input" id="policyVersion" value="v2.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="refundPolicy">Refund Policy (hours before event)</label>
                                    <input type="number" class="form-input" id="refundPolicy" value="24" min="0" max="168">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="serviceFee">Service Fee (‚Ç¨)</label>
                                    <input type="number" class="form-input" id="serviceFee" value="2.50" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="minAge">Minimum Age for Events</label>
                                    <input type="number" class="form-input" id="minAge" value="16" min="0" max="25">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="dressCode">Default Dress Code</label>
                                    <select class="form-input" id="dressCode">
                                        <option value="Casual">Casual</option>
                                        <option value="Smart Casual">Smart Casual</option>
                                        <option value="Business Casual">Business Casual</option>
                                        <option value="Formal">Formal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="contactEmail">Contact Email</label>
                                    <input type="email" class="form-input" id="contactEmail" value="contact@studentevents.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="contactPhone">Contact Phone</label>
                                    <input type="tel" class="form-input" id="contactPhone" value="+1 (555) 123-4567">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Save Policy Changes
                                </button>
                            </form>
                        </div>

                        <!-- Policy Text Editor -->
                        <div class="settings-section">
                            <h3 class="settings-section-title">
                                <i class="fas fa-edit"></i>
                                Policy Text Editor
                            </h3>
                            <form class="settings-form" id="policyTextForm">
                                <div class="form-group">
                                    <label class="form-label" for="privacyPolicyText">Privacy Policy Text</label>
                                    <textarea class="form-textarea" id="privacyPolicyText" rows="8" placeholder="Enter privacy policy text here...">We collect information you provide directly to us, such as when you create an account, purchase tickets, or contact us for support. This may include name, email address, and phone number. We use this information to provide and improve our services.</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="refundPolicyText">Refund Policy Text</label>
                                    <textarea class="form-textarea" id="refundPolicyText" rows="6" placeholder="Enter refund policy text here...">Refunds are available up to 24 hours before the event. Service fees are non-refundable. To request a refund, contact us with your ticket information.</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="termsOfServiceText">Terms of Service Text</label>
                                    <textarea class="form-textarea" id="termsOfServiceText" rows="6" placeholder="Enter terms of service text here...">By using our service, you agree to follow our code of conduct and respect other attendees. We reserve the right to remove anyone who violates these terms.</textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Save Policy Text
                                </button>
                            </form>
                        </div>

                        <!-- System Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title">
                                <i class="fas fa-server"></i>
                                System
                            </h3>
                            <form class="settings-form" id="systemForm">
                                <div class="form-group">
                                    <div class="form-checkbox">
                                        <input type="checkbox" id="emailNotifications" checked>
                                        <label for="emailNotifications">Email Notifications</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="form-checkbox">
                                        <input type="checkbox" id="smsNotifications">
                                        <label for="smsNotifications">SMS Notifications</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="form-checkbox">
                                        <input type="checkbox" id="autoBackup" checked>
                                        <label for="autoBackup">Automatic Backups</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="timezone">Timezone</label>
                                    <select class="form-input" id="timezone">
                                        <option value="UTC">UTC</option>
                                        <option value="Europe/London">Europe/London</option>
                                        <option value="Europe/Berlin" selected>Europe/Berlin</option>
                                        <option value="America/New_York">America/New_York</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Save Changes
                                </button>
                            </form>
                        </div>

                        <!-- Backup & Export -->
                        <div class="settings-section">
                            <h3 class="settings-section-title">
                                <i class="fas fa-database"></i>
                                Data Management
                            </h3>
                            <div class="settings-actions">
                                <button class="btn btn-secondary" onclick="adminDashboard.backupData()">
                                    <i class="fas fa-download"></i>
                                    Backup Data
                                </button>
                                <button class="btn btn-secondary" onclick="adminDashboard.exportAllData()">
                                    <i class="fas fa-file-export"></i>
                                    Export All Data
                                </button>
                                <button class="btn btn-danger" onclick="adminDashboard.clearOldData()">
                                    <i class="fas fa-trash-alt"></i>
                                    Clear Old Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="/rules.html" class="footer-link">Rules & Policy</a>
                    <a href="#contact" class="footer-link">Contact</a>
                </div>
                <div class="footer-info">
                    <p>&copy; 2024 StudentEvents. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="/scripts/main.js"></script>
    <!-- Edit Event Modal -->
    <div class="modal" id="editEventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Event</h3>
                <button class="modal-close" onclick="adminDashboard.closeEditEventModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form class="modal-form" id="editEventForm">
                <div class="form-group">
                    <label class="form-label" for="editEventName">Event Name</label>
                    <input type="text" class="form-input" id="editEventName" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="editEventDate">Date & Time</label>
                    <input type="datetime-local" class="form-input" id="editEventDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="editEventLocation">Location</label>
                    <input type="text" class="form-input" id="editEventLocation" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="editEventDescription">Description</label>
                    <textarea class="form-textarea" id="editEventDescription" rows="4"></textarea>
                </div>
                
                <!-- Price Tiers Section -->
                <div class="form-group">
                    <label class="form-label">Price Tiers</label>
                    <div id="editPriceTiers">
                        <!-- Price tiers will be dynamically added here -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="adminDashboard.addPriceTier('edit')">
                        <i class="fas fa-plus"></i> Add Price Tier
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editEventImage">Event Image URL</label>
                    <input type="url" class="form-input" id="editEventImage" placeholder="https://example.com/image.jpg">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editEventStatus">Status</label>
                    <select class="form-input" id="editEventStatus">
                        <option value="active">Active</option>
                        <option value="sold-out">Sold Out</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="adminDashboard.closeEditEventModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="/scripts/config.js"></script>
    <script src="/admin/admin-dashboard.js"></script>
    <script src="/admin/admin-api-connector.js"></script>
    <script>
        // Proper authentication check with JWT token validation
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                window.location.href = 'login.html';
            }
        });
        
        async function checkAuthentication() {
            try {
                // Check if JWT token exists
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    console.log('‚ùå No JWT token found');
                    return false;
                }
                
                // Check token expiration
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const now = Math.floor(Date.now() / 1000);
                    
                    if (payload.exp < now) {
                        console.log('‚ùå JWT token expired');
                        clearAuthData();
                        return false;
                    }
                } catch (error) {
                    console.log('‚ùå Invalid JWT token format');
                    clearAuthData();
                    return false;
                }
                
                // Verify token with server (with fallback)
                const API_BASE_URL = window.CONFIG?.API_BASE_URL?.replace('/api', '') || 'https://studentevents-production.up.railway.app';
                try {
                    const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (!data.success || data.user.role !== 'admin') {
                            console.log('‚ùå User is not an admin');
                            clearAuthData();
                            return false;
                        }
                        console.log('‚úÖ Server token verification successful');
                    } else {
                        console.log('‚ö†Ô∏è Server verification failed, using client-side validation');
                        // Fallback to client-side validation
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        if (payload.role !== 'admin') {
                            console.log('‚ùå User is not an admin (client-side check)');
                            clearAuthData();
                            return false;
                        }
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Server verification error, using client-side validation:', error.message);
                    // Fallback to client-side validation
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    if (payload.role !== 'admin') {
                        console.log('‚ùå User is not an admin (client-side check)');
                        clearAuthData();
                        return false;
                    }
                }
                
                console.log('‚úÖ Authentication successful');
                startTokenValidation(); // Start periodic token validation
                return true;
                
            } catch (error) {
                console.error('‚ùå Authentication check failed:', error);
                clearAuthData();
                return false;
            }
        }
        
        function clearAuthData() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            sessionStorage.removeItem('adminAccess');
        }
        
        // Periodic token validation (every 5 minutes)
        function startTokenValidation() {
            setInterval(async () => {
                const token = localStorage.getItem('adminToken');
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const now = Math.floor(Date.now() / 1000);
                        const timeUntilExpiry = payload.exp - now;
                        
                        // If token expires in less than 5 minutes, refresh it
                        if (timeUntilExpiry < 300) {
                            console.log('üîÑ Token expiring soon, refreshing...');
                            await refreshToken();
                        }
                    } catch (error) {
                        console.error('Token validation error:', error);
                        clearAuthData();
                        window.location.href = 'login.html';
                    }
                }
            }, 300000); // Check every 5 minutes
        }
        
        async function refreshToken() {
            try {
                const token = localStorage.getItem('adminToken');
                const API_BASE_URL = window.CONFIG?.API_BASE_URL?.replace('/api', '') || 'https://studentevents-production.up.railway.app';
                
                const response = await fetch(`${API_BASE_URL}/api/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('adminToken', data.token);
                    console.log('‚úÖ Token refreshed successfully');
                } else {
                    throw new Error('Token refresh failed');
                }
            } catch (error) {
                console.error('Token refresh failed:', error);
                clearAuthData();
                window.location.href = 'login.html';
            }
        }
        
        function adminLogout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear all authentication data
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                sessionStorage.removeItem('adminAccess');
                
                // Optional: Call logout API to invalidate token on server
                const token = localStorage.getItem('adminToken');
                if (token) {
                    fetch('https://studentevents-production.up.railway.app/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }).then(response => {
                        if (response.ok) {
                            console.log('‚úÖ Server logout successful');
                        } else {
                            console.log('‚ö†Ô∏è Server logout failed, but continuing with client logout');
                        }
                    }).catch(error => {
                        console.warn('‚ö†Ô∏è Logout API call failed, but continuing with client logout:', error.message);
                        // Continue with logout even if API call fails
                    });
                }
                
                // Redirect to login page
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
