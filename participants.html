<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Participants Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f6f8; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { margin: 0 0 20px; color: #333; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; }
    select, input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
    button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    button.secondary { background: #6c757d; }
    .stats { margin: 15px 0; padding: 10px; background: #e9ecef; border-radius: 4px; color: #495057; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; border-bottom: 1px solid #dee2e6; text-align: left; }
    th { background: #f8f9fa; font-weight: 600; }
    tr:hover { background: #f8f9fa; }
    .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: capitalize; }
    .paid { background: #d4edda; color: #155724; }
    .pending { background: #fff3cd; color: #856404; }
    .cancelled { background: #f8d7da; color: #721c24; }
    .loading { text-align: center; padding: 40px; color: #6c757d; }
    .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 10px 0; }
    .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 4px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📋 All Participants</h1>
    
    <div class="controls">
      <select id="eventFilter">
        <option value="all">All Events</option>
      </select>
      <select id="statusFilter">
        <option value="all">All Statuses</option>
        <option value="paid">Paid</option>
        <option value="pending">Pending</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <input id="searchBox" placeholder="Search name/email/reference...">
      <button onclick="loadData()">🔄 Refresh</button>
      <button onclick="exportCSV()" id="exportBtn" disabled>📊 Export CSV</button>
    </div>

    <div id="message"></div>
    <div id="stats"></div>
    
    <table>
      <thead>
        <tr>
          <th>Event</th>
          <th>Status</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Reference</th>
        </tr>
      </thead>
      <tbody id="participantsTable"></tbody>
    </table>
  </div>

  <script>
    const API = 'https://studentevents-production.up.railway.app/api';
    let allParticipants = [];
    let filteredParticipants = [];

    function showMessage(message, type = 'info') {
      const messageEl = document.getElementById('message');
      messageEl.innerHTML = `<div class="${type}">${message}</div>`;
    }

    function clearMessage() {
      document.getElementById('message').innerHTML = '';
    }

    async function loadData() {
      clearMessage();
      showMessage('🔄 Loading participants...', 'info');
      
      const token = localStorage.getItem('adminToken');
      if (!token) {
        showMessage('❌ Not logged in. Please log into admin dashboard first, then return to this page.', 'error');
        return;
      }

      try {
        const res = await fetch(`${API}/admin/bookings`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) {
          showMessage(`❌ Failed to load bookings: ${res.status} ${res.statusText}`, 'error');
          return;
        }

        const bookings = await res.json();
        console.log('📊 Loaded bookings:', bookings.length);
        
        // Flatten all participants from bookings
        allParticipants = bookings.flatMap(b => {
          // If backend provides attendees array, use it; otherwise use main contact
          const attendees = Array.isArray(b.attendees) && b.attendees.length 
            ? b.attendees 
            : [{ first_name: b.first_name, last_name: b.last_name, email: b.email }];
          
          return attendees.map(a => ({
            event: b.event_title || 'Unknown Event',
            status: b.payment_status,
            firstName: a.first_name || '',
            lastName: a.last_name || '',
            email: a.email || '',
            reference: b.payment_reference || ''
          }));
        });

        console.log('👥 Total participants:', allParticipants.length);
        
        populateEventFilter();
        applyFilters();
        showMessage(`✅ Loaded ${allParticipants.length} participants successfully!`, 'success');
        
      } catch (error) {
        console.error('❌ Error loading data:', error);
        showMessage(`❌ Error: ${error.message}`, 'error');
      }
    }

    function populateEventFilter() {
      const events = [...new Set(allParticipants.map(p => p.event))].sort();
      const select = document.getElementById('eventFilter');
      select.innerHTML = '<option value="all">All Events</option>' + 
        events.map(event => `<option value="${event}">${event}</option>`).join('');
    }

    function applyFilters() {
      const eventFilter = document.getElementById('eventFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();

      filteredParticipants = allParticipants.filter(p => {
        if (eventFilter !== 'all' && p.event !== eventFilter) return false;
        if (statusFilter !== 'all' && p.status !== statusFilter) return false;
        if (searchTerm) {
          const searchText = `${p.firstName} ${p.lastName} ${p.email} ${p.reference} ${p.event}`.toLowerCase();
          if (!searchText.includes(searchTerm)) return false;
        }
        return true;
      });

      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('participantsTable');
      
      if (filteredParticipants.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6c757d;">No participants found</td></tr>';
        document.getElementById('exportBtn').disabled = true;
        return;
      }

      tbody.innerHTML = filteredParticipants.map(p => `
        <tr>
          <td>${escapeHtml(p.event)}</td>
          <td><span class="badge ${p.status}">${p.status}</span></td>
          <td>${escapeHtml(p.firstName)}</td>
          <td>${escapeHtml(p.lastName)}</td>
          <td>${escapeHtml(p.email)}</td>
          <td>${escapeHtml(p.reference)}</td>
        </tr>
      `).join('');

      document.getElementById('stats').innerHTML = 
        `📊 Showing ${filteredParticipants.length} of ${allParticipants.length} participants`;
      
      document.getElementById('exportBtn').disabled = false;
    }

    function escapeHtml(text) {
      return String(text || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function exportCSV() {
      if (filteredParticipants.length === 0) {
        showMessage('❌ No data to export', 'error');
        return;
      }

      const headers = ['Event', 'Status', 'First Name', 'Last Name', 'Email', 'Reference'];
      const csv = [headers.join(',')].concat(filteredParticipants.map(p => 
        headers.map(h => {
          const key = h.toLowerCase().replace(' ', '');
          const value = p[key] || '';
          return `"${value.toString().replace(/"/g, '""')}"`;
        }).join(',')
      )).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `participants-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showMessage(`✅ Exported ${filteredParticipants.length} participants to CSV`, 'success');
    }

    // Event listeners
    document.getElementById('eventFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('searchBox').addEventListener('input', applyFilters);

    // Load data on page load
    window.addEventListener('load', () => {
      console.log('🔧 Participants Viewer loaded');
      loadData();
    });
  </script>
</body>
</html>
